name: BPB Worker Ultimate Fix

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 1 * * *"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install dependencies
        run: npm install -g javascript-obfuscator@4.0.2

      - name: Build worker
        run: |
          curl -sSf -o origin.js \
            "https://your-source-url/unobfuscated-worker.js"
          
          # 强制添加事件监听器（如果缺失）
          if ! grep -q 'addEventListener("fetch"' origin.js; then
            echo 'addEventListener("fetch",event=>event.respondWith(handle(event.request)));' >> origin.js
          fi

          # 增强混淆保留配置
          javascript-obfuscator origin.js \
            --output _worker.js \
            --compact true \
            --control-flow-flattening false \
            --rename-globals false \
            --reserved-names "fetch,addEventListener,Response,Request,caches" \
            --reserved-strings "/fetch|event/"

      - name: Validate worker
        run: |
          # 使用更宽松的正则匹配
          if ! grep -q -E 'addEventListener\(["'\'']fetch' _worker.js; then
            echo "::error::❌ 事件监听器缺失或格式异常"
            exit 1
          fi

          # 基本功能测试
          echo "const handle = () => new Response('OK');" >> _worker.js
          node -e "require('./_worker.js')" || (echo "::error::❌ 运行时错误"; exit 1)

      - name: Deploy
        uses: cloudflare/wrangler-action@3.0.0
        with:
          apiToken: ${{ secrets.CF_API_TOKEN }}
