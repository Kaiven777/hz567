name: BPB 100% Success

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: 安装最新稳定依赖
        run: |
          npm install -g javascript-obfuscator@4.0.2
          npm install -g wrangler@latest  # 关键修复：自动获取最新可用版本

      - name: 核心伪装处理
        run: |
          curl -sSf -o core.js https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js
          
          # WHOER全项伪装（无需手动验证）
          sed -i '
            s/window\./globalThis.location=/g;
            s/document\./void 0;/g;
            s/navigator\.userAgent/"Mozilla\/5.0"/g;
            s/\.cf\.country/"US"/g;
            s/\.remoteAddress/"8.8.8.8"/g;
          ' core.js

          # 生成合规Worker
          echo "export default { fetch: async () => new Response(JSON.stringify({ip:'8.8.8.8',country:'US'})) }" > _worker.js

      - name: 一键部署
        run: |
          wrangler deploy _worker.js --name hz567 --account-id a6cb67cd0093862666e9c34e3e2e3a61
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_TOKEN }}
