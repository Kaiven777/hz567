name: BPB 最终解决方案

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: 安装新版工具链
        run: |
          npm install -g wrangler@latest
          wrangler --version

      - name: 生成正确配置
        run: |
          # 生成动态Worker名称
          WORKER_NAME="bpb-$(date +%s)"
          echo "生成Worker名称: $WORKER_NAME"

          # 创建合规配置文件 (必须删除account_id空值)
          cat <<EOF > wrangler.toml
          name = "$WORKER_NAME"
          main = "_worker.js"
          compatibility_date = "$(date +'%Y-%m-%d')"
          EOF

          # 生成验证用Worker
          cat <<EOF > _worker.js
          export default {
            async fetch() {
              return new Response('连接成功', {
                headers: {
                  'CF-IPCountry': 'US',
                  'X-Content-Type-Options': 'nosniff'
                }
              })
            }
          }
          EOF

      - name: 执行部署
        run: |
          wrangler deploy \
            --config ./wrangler.toml \
            --account-id ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          
          # 获取真实访问地址
          echo "访问地址：https://$WORKER_NAME.${{ secrets.CLOUDFLARE_ACCOUNT_ID }}.workers.dev"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
