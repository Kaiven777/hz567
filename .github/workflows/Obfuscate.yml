name: BPB Worker Ultimate Fix

on:
  push:
    branches: [main]
  schedule:
    - cron: "0 1 * * *"

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: 强制密钥检查
        if: ${{ !secrets.CLOUDFLARE_API_TOKEN || !secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "::error::❌ 请前往仓库Settings→Secrets→Actions添加CLOUDFLARE_API_TOKEN和CLOUDFLARE_ACCOUNT_ID"
          exit 1

      - uses: actions/checkout@v4

      - name: 安装已验证依赖
        run: |
          npm install -g javascript-obfuscator@4.0.2
          npm install -g wrangler@4.7.0  # 使用已验证稳定版本

      - name: 构建Worker
        run: |
          curl -sSf -o origin.js https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js
          
          # WHOER全项修复（美东时区+谷歌IP）
          sed -i.bak '
            s/window\./globalThis.location=/g;
            s/document\./void 0;/g;
            s/navigator\.userAgent/"Mozilla\/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit\/537.36"/g;
            s/new Date()/new Date(Date.now() + 28800000)/g;
            s/\.headers\.get("Accept-Language")/"en-US,en;q=0.9"/g;
            s/\.cf\.country/"US"/g;
            s/\.cf\.colo/"IAD"/g;
            s/\.remoteAddress/"8.8.8.8"/g;
          ' origin.js

          # 语法验证
          node -c origin.js || (echo "::error::预处理文件语法错误"; exit 1)

      - name: 安全混淆
        run: |
          javascript-obfuscator origin.js --output _worker.js \
            --compact true \
            --identifier-names-generator hexadecimal \
            --rename-globals false \
            --reserved-names "fetch,addEventListener,Response,Request,Headers,URL" \
            --reserved-strings "/(US|IAD|8\.8\.8\.8|en-US)/i"

      - name: 部署到Cloudflare
        run: |
          wrangler deploy _worker.js \
            --name hz567 \
            --compatibility-date $(date +'%Y-%m-%d')
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
