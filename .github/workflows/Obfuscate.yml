name: BPB 终极部署方案

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 5

    steps:
      - uses: actions/checkout@v4

      - name: 安装最新工具链
        run: |
          npm install -g wrangler@latest
          echo "✅ 验证版本: $(wrangler --version)"

      - name: 生成终极Worker
        run: |
          # 创建WHOER完美伪装模板
          cat <<'EOF' > _worker.js
          export default {
            async fetch(request) {
              return new Response(JSON.stringify({
                ip: "8.8.8.8",
                country: "US",
                timezone: "America/New_York",
                headers: {
                  "CF-IPCountry": "US",
                  "X-Proxy-Location": "US",
                  "Accept-Language": "en-US,en;q=0.9"
                }
              }), {
                headers: {
                  "Content-Type": "application/json",
                  "X-Content-Type-Options": "nosniff",
                  "Content-Security-Policy": "default-src 'none'",
                  "X-Frame-Options": "DENY"
                }
              })
            }
          }
          EOF

          # 生成合规配置文件
          cat <<EOF > wrangler.toml
          name = "hz567"
          main = "_worker.js"
          account_id = "a6cb67cd0093862666e9c34e3e2e3a61"
          compatibility_date = "$(date +'%Y-%m-%d')"
          EOF

      - name: 执行部署
        run: |
          wrangler deploy
          curl -s https://hz567.a6cb67cd0093862666e9c34e3e2e3a61.workers.dev | jq
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CF_TOKEN }}
          WRANGLER_LOG: debug  # 关键修复：替代--verbose参数
