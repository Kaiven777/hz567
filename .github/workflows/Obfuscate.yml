name: BPB Worker Final Fix

on:
  push:
    branches: [main]

permissions:
  contents: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          cache: "npm"

      - name: Install dependencies
        run: |
          npm install javascript-obfuscator@4.0.2
          npm install wrangler@4.12.0

      - name: Secure source processing
        run: |
          # 步骤1：安全下载原始文件
          curl -sSf -o raw.js \
            "https://raw.githubusercontent.com/bia-pain-bache/BPB-Worker-Panel/main/build/unobfuscated-worker.js"
          
          # 步骤2：语法安全替换（新方案）
          sed -i.bak '
            # 浏览器环境模拟（不含破坏性修改）
            s/window\./globalThis.location=/g;
            s/document\./void 0;/g;
            s/navigator\.userAgent/"Mozilla\\/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit\\/537.36"/g;
            
            # 地理信息加固（显式声明方式）
            s/$request\|event$\.cf\.country/"US"/g;
            s/$request\|event$\.cf\.colo/"IAD"/g;
            s/$\w\+$\.remoteAddress/"8.8.8.8"/g;
            
            # 时区校正（ISO标准格式）
            s/new Date()/new Date(Date.now() + 28800000).toISOString()/g;
          ' raw.js

          # 步骤3：语法校验（关键修复）
          node -c raw.js || (echo "::error::Source syntax error"; exit 1)

      - name: Safe obfuscation
        run: |
          # 防御性混淆配置（新参数）
          npx javascript-obfuscator raw.js \
            --output _worker.js \
            --compact false \
            --identifier-names-generator dictionary \
            --identifiers-prefix 'bpb_' \
            --rename-globals false \
            --control-flow-flattening false \
            --dead-code-injection false \
            --reserved-names "fetch,addEventListener,Response,Request,caches,Headers,URL,Date,location" \
            --reserved-strings "/(US|IAD|8\.8\.8\.8|en-US)/i"

          # 混淆后语法验证
          node -c _worker.js || (echo "::error::Obfuscated code error"; exit 1)

      - name: Final deployment
        run: |
          npx wrangler deploy _worker.js \
            --name bpb-worker \
            --compatibility-date $(date +'%Y-%m-%d')
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
